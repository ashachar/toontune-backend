# Text Behind Head Renderer

This directory contains scripts for rendering text with proper depth layering, where text appears **behind** the person in the video (not overlaid on top).

## Files

- `render_text_behind_head.py` - Main renderer for text-behind-head effect
- `test_text_behind_head.py` - Test script with usage examples
- `main.py` - Original ASS subtitle generator (overlays text on top)
- `layout.py`, `utils.py`, `word_animator.py` - Shared utilities

## Key Difference: ASS vs Text Behind Head

### ASS Subtitles (main.py)
- Text appears **on top** of everything
- Uses FFmpeg subtitle filter for fast processing  
- Cannot achieve true depth - text always visible over person
- Good for normal subtitles

### Text Behind Head (render_text_behind_head.py)
- Text appears **behind** the person using true masking
- Frame-by-frame OpenCV processing
- Text is completely hidden where person appears
- Perfect for cinematic depth effects

## Usage

### Basic Usage
```bash
python render_text_behind_head.py <video> <mask_video> <transcript> -o <output>
```

### Example
```bash
python render_text_behind_head.py \
    ai_math1_6sec.mp4 \
    ../../uploads/assets/videos/ai_math1/ai_math1_rvm_mask.mp4 \
    ../../uploads/assets/videos/ai_math1/transcript_enriched_partial.json \
    -o output_with_text_behind_head.mp4
```

### Run Test
```bash
python test_text_behind_head.py
```

## Input Requirements

### 1. Video File
- Any MP4 video file
- Will be processed frame-by-frame

### 2. Mask Video File  
- Same duration and frame rate as main video
- **White pixels = person (foreground)**
- **Black pixels = background (where text appears)**
- Usually generated by RVM (Robust Video Matting)

### 3. Enriched Transcript
- JSON file with word-by-word timing and styling
- Must include:
  - `phrases[]` with `words`, `start_time`, `end_time`
  - `visual_style` with font size, colors, etc.
  - `position` ("top" or "bottom")
  - `emphasis_type` for styling

## Features

### Text Styling
- **Black borders** around text for visibility
- **Color tinting** support from transcript
- **Bold text** for emphasis
- **Multiple font sizes** based on importance

### Animations
- **Slide from above** - text drops into place
- **Fade in** - gradual opacity increase  
- **Word-by-word timing** - each word appears individually

### Masking
- **Perfect occlusion** - text hidden behind person
- **Background-only rendering** - text only in black mask areas
- **Maintains original video quality**

### Layout
- **Top and bottom zones** based on transcript position
- **Center alignment** horizontally
- **Multi-line support** for long phrases
- **Smart spacing** between words and lines

## Output

The script generates two files:
1. `<output>.mp4` - Intermediate file (removed after conversion)
2. `<output>_h264.mp4` - Final H.264 encoded video

The H.264 version is optimized for:
- Web playback compatibility
- Fast seeking (`+faststart` flag)
- Good compression vs quality balance

## Technical Details

### Processing Pipeline
1. **Load transcript** - Parse phrases and timing
2. **Open video streams** - Main video + mask video
3. **Frame-by-frame processing**:
   - Calculate active words at current time
   - Generate layout for each phrase
   - Apply slide/fade animations
   - Render text to transparent layer
   - Apply mask to hide text behind person
   - Composite with original frame
4. **Export video** - Write processed frames
5. **Convert to H.264** - Final encoding

### Coordinate System
- Uses **FFmpeg coordinate convention** (top-left origin)
- Text positioning accounts for slide animation
- Proper clipping to frame boundaries

### Performance
- ~25-30 fps processing speed (for 720p video)
- Memory efficient (processes one frame at a time) 
- Progress reporting every 30 frames

### Dependencies
- OpenCV (`cv2`) - Video processing and compositing
- PIL/Pillow (`PIL`) - Text rendering with borders
- NumPy (`numpy`) - Array operations for masking

## When to Use

### Use Text Behind Head When:
- Text should appear to be part of the background
- Person's movement should naturally occlude text
- Creating cinematic depth effects
- Text content is environmental/contextual

### Use ASS Subtitles When:
- Normal subtitle overlay behavior is desired
- Fast processing is priority
- Text should always be visible over video
- File size optimization is important

## Troubleshooting

### Common Issues

**"Video file not found"**
- Check file paths are correct
- Use absolute paths if needed

**"Different frame counts between video and mask"**
- Ensure mask video has same duration as main video
- Check both videos have same frame rate

**"Text not appearing"**
- Check transcript timing matches video duration
- Verify mask has black areas where text should appear
- Check current_time calculation vs phrase start_time

**"Text appearing over person"**
- Verify mask polarity: white=person, black=background
- Check mask video is synchronized with main video
- Ensure mask covers the person completely

### Debug Tips
- Add print statements to track active words at specific times
- Save intermediate text layers to debug positioning
- Check mask values at text locations
- Verify animation progress calculations